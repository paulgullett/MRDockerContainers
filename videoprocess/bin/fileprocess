#! /bin/bash

# Script requires an argument this is the name of the file to process

function_message() {

	completionstatus=$1
        completionmessage=$2

	jq -n --arg completionstatus "$completionstatus" --arg completionmessage "$completionmessage" --arg owner "$owner" --arg room "$room" --arg team "$team" --arg filename "$filename" --arg directory "$directory" --arg file "$file" --arg filesequence "$filesequence" '. | .["completionstatus"]=$completionstatus | .["completionmessage"]=$completionmessage | .["owner"]=$owner | .["room"]=$room | .["team"]=$team | .["filename"]=$filename | .["directory"]=$directory | .["file"]=$file| .["filesequence"]=$filesequence' > db.json

        aws sqs send-message --queue-url https://sqs.eu-west-1.amazonaws.com/451524384759/MRVideoProcessingCompletionQueue --message-body file://db.json

        rm db.json
	cd /root/processdir
	rm -rf $processdirectory
        exit
}

if [ "$#" -ne 1 ]
then
	echo "Script needs a filename"
	exit
fi

longfilename=$1

processdirectory=$(pwgen -s 64 1 | tr '[:upper:]' '[:lower:]')
directory=$(pwgen -s 64 1 | tr '[:upper:]' '[:lower:]')
file=$(pwgen -s 64 1 | tr '[:upper:]' '[:lower:]')
filesequence=$(pwgen -s 64 1 | tr '[:upper:]' '[:lower:]')

cd /root/processdir
mkdir $processdirectory
cd $processdirectory

owner=""
room=""
team=""
filename=""

IFS='_' read -r -a array <<< $longfilename
owner=${array[0]}
room=${array[1]}
team=${array[2]}
filename=${array[3]}

aws s3 mv s3://meetingroomv1uploads/${longfilename} . --quiet

mv ${longfilename} ${filename}

codec=$(/root/bin/ffprobe -v error -select_streams v:0 -show_entries stream=codec_name -of default=noprint_wrappers=1:nokey=1 ${filename})
	
if [ "$codec" != "h264" ]
then
	completionstatus="Failed"
	completionmessage="Not a h264 encoded file."
	function_message "$completionstatus" "$completionmessage"
fi

duration=$(/root/bin/ffprobe -v error -select_streams v:0 -show_entries stream=duration -of default=noprint_wrappers=1:nokey=1 ${filename})
	
if [ $(echo "$duration > 300" | bc) -eq 1 ]
then
	completionstatus="Failed"
	completionmessage="Video should be less than 5mins in length"
	function_message "$completionstatus" "$completionmessage"
fi

/root/bin/ffmpeg -hide_banner -y -i ${filename} -loglevel quiet \
	-vf transform360="input_stereo_format=MONO:cube_edge_length=512:interpolation_alg=cubic:enable_low_pass_filter=1:enable_multi_threading=1:num_horizontal_segments=32:num_vertical_segments=15:adjust_kernel=1" \
	proc_${filename}

if [ $? -ne 0 ]
then
	completionstatus="Failed"
	completionmessage="Video pre-process failure"
	function_message "$completionstatus" "$completionmessage"
fi

/root/bin/ffmpeg -hide_banner -y -i proc_${filename} -loglevel quiet \
	-preset slow -crf 20 -profile:v main \
	-sc_threshold 0 -g 48 -keyint_min 48 \
	-map 0:0 -map 0:1 \
	-map 0:0 -map 0:1 \
	-map 0:0 -map 0:1 \
	-map 0:0 -map 0:1 \
	-c:v:0 libx264 -c:a:0 aac -b:v:0 256k -b:a:0 64k -s:v:0 960x480 \
	-c:v:1 libx264 -c:a:1 aac -b:v:1 512k -b:a:1 64k -s:v:1 1440x720 \
	-c:v:2 libx264 -c:a:2 aac -b:v:2 768k -b:a:2 64k -s:v:2 1920x960 \
	-c:v:3 libx264 -c:a:3 aac -b:v:3 1024k -b:a:3 64k -s:v:3 2880x1440 \
	-var_stream_map "v:0,a:0 v:1,a:1 v:2,a:2 v:3,a:3" \
	-master_pl_name ${file}.m3u8 \
	-f hls -hls_time 2 -hls_list_size 0 \
	-hls_segment_filename "${directory}/v%v/${filesequence}_%d.ts" \
	${directory}/v%v/${filesequence}_index.m3u8

if [ $? -ne 0 ]
then
	completionstatus="Failed"
	completionmessage="Video conversion failure"
	function_message "$completionstatus" "$completionmessage"
fi

cd $directory
sed -i "s|^v[0-9].*|https://prometheus.meetingroom.io/videos/$team/$directory/&|g" ${file}.m3u8
cd ..
aws s3 cp ${directory} s3://meetingroomv1public/videos/${team}/${directory}/ --recursive --quiet

if [ $? -ne 0 ]
then
	completionstatus="Failed"
	completionmessage="Video move failure"
	function_message "$completionstatus" "$completionmessage"
fi

completionstatus="Success"
completionmessage="Video conversion complete"
function_message "$completionstatus" "$completionmessage"

# Exit container
exit
